<script>
// ------------ Emotion Engine v2.0 ------------

// دمو استیت – بعداً می‌تونیم به فید واقعی وصلش کنیم
const DEMO_STATE = {
  minute: 72,
  xgHome: 2.1,
  xgAway: 0.9,
  shotsHome: 12,
  shotsAway: 7,
  dangerousAttacksHome: 28,
  dangerousAttacksAway: 11,
  prePrice: 2.40,
  livePrice: 1.70,
  edgeVsMarket: 3.1
};

// هستهٔ Emotion Engine 2.0
function runEmotionEngine(mode) {
  const s = DEMO_STATE;

  // فشار لحظه‌ای (۰ تا ۱۰۰)
  const pressureRaw =
    (s.xgHome - s.xgAway) * 28 +
    (s.shotsHome - s.shotsAway) * 6 +
    (s.dangerousAttacksHome - s.dangerousAttacksAway) * 1.2;

  const pressureScore = Math.max(0, Math.min(100, Math.round(50 + pressureRaw)));

  let pressureLabel;
  if (pressureScore >= 80) {
    pressureLabel = "Sustained home siege – market pinned back";
  } else if (pressureScore >= 60) {
    pressureLabel = "Persistent home pressure – away side hanging on";
  } else if (pressureScore >= 40) {
    pressureLabel = "Balanced but tilting home – volatility risk";
  } else {
    pressureLabel = "Thin home edge – fragile control, keep size small";
  }

  // فشردگی قیمت‌ها بین pre و live
  const compression = ((s.prePrice / s.livePrice) - 1) * 100;

  let marketMood;
  if (compression >= 40) {
    marketMood = "Market has chased the move – late money crowding in.";
  } else if (compression >= 20) {
    marketMood = "Market leaning home side but still leaves room for smart orders.";
  } else {
    marketMood = "Market slow to react – price still close to opener.";
  }

  // مود احساسی جمعیت و بازار
  let crowdMood;
  if (pressureScore >= 75 && compression >= 30) {
    crowdMood = "Home side turns from anxious to confident – noise flips into one-way belief.";
  } else if (pressureScore >= 60) {
    crowdMood = "Momentum building – home crowd sensing a decisive phase, away bench nervous.";
  } else if (pressureScore >= 40) {
    crowdMood = "Both benches alert – one big moment could flip the read entirely.";
  } else {
    crowdMood = "Nervous calm – market and crowd still respect all three outcomes.";
  }

  // پنجرهٔ ترید – چیزی که برای بتینگ‌شاپ و دیسک ترید مهمه
  let tradeWindow;
  let tradeRationale;

  if (pressureScore >= 80 && compression < 50) {
    tradeWindow = "Now — high-conviction window";
    tradeRationale =
      "Pressure, xG and volume all align on the home side while price still lags slightly " +
      "behind the true trend. Ideal spot for sized-up exposure with tight monitoring.";
  } else if (pressureScore >= 60) {
    tradeWindow = "Next 60–180s — stagger entries";
    tradeRationale =
      "Home pressure is real but market hasn’t fully resolved. Use smaller tickets and staggered " +
      "entries rather than a single all-in click.";
  } else if (pressureScore >= 40) {
    tradeWindow = "Watch only — volatility phase";
    tradeRationale =
      "Signals conflict: pressure is rising but not clean, and any next event can reverse the edge. " +
      "Use this zone to prepare levels, not to add risk.";
  } else {
    tradeWindow = "Edge mostly priced — protect P&L";
    tradeRationale =
      "Current read is close to market consensus. Focus on risk reduction and exit path rather than new risk.";
  }

  const phases = [
    {
      label: "Balanced opener",
      minute: "0' – 30'",
      description:
        "Market respects all three outcomes. xG and shots are roughly aligned, liquidity deep on both sides."
    },
    {
      label: "Home pressure unlocks",
      minute: "30' – 72'",
      description:
        "Sustained home attacks push xG and dangerous entries higher. Live price starts to compress towards the home side."
    },
    {
      label: "Late-game control",
      minute: "72' – 90'",
      description:
        "After the late home goal, price and sentiment lock into a home-favoured regime. Biggest risk is a chaotic equaliser."
    }
  ];

  const headline =
    "Late home goal snaps the match into a new regime – market and mood now move in sync.";
  const quickStory =
    "BetSense Emotion Engine 2.0 reads a sustained home surge turning into a one-way phase. " +
    "Pressure, xG and price compression all support a home-favouring stance, but the trade " +
    "window is narrow and needs disciplined execution.";
  const deepStory =
    "Across the full match, the engine tracks how raw pressure, xG and crowd energy break away " +
    "from the pre-match baseline. Once the late home goal lands, our regime detector flags a " +
    "clean structural break – the game no longer behaves like the opener. From this point the " +
    "priority shifts from hunting entry to managing exit and tail-risk around a possible equaliser.";

  const tags = [
    "Regime break",
    "Sustained home pressure",
    "Liquid derby fixture",
    "Late-goal volatility",
    `Edge +${s.edgeVsMarket.toFixed(1)}% vs market`
  ];

  return {
    mode,
    headline,
    quickStory,
    deepStory,
    tags,
    pressureScore,
    pressureLabel,
    crowdMood,
    marketMood,
    tradeWindow,
    tradeRationale,
    phases,
    compression: Math.round(compression)
  };
}

// رندر نسخهٔ سریع
function renderEmotionQuick() {
  const result = runEmotionEngine("quick");
  const box = document.getElementById("emotion-output");
  if (!box) return;

  box.innerHTML = `
    <div class="emotion-v2">
      <p class="eyebrow">Quick read — Emotion Engine 2.0</p>
      <h4>${result.headline}</h4>
      <p>${result.quickStory}</p>

      <div class="emotion-v2-grid">
        <div class="emotion-v2-metric">
          <p><strong>Real-time pressure</strong></p>
          <p>${result.pressureLabel}</p>
          <p>Pressure score: ${result.pressureScore} / 100</p>
        </div>
        <div class="emotion-v2-metric">
          <p><strong>Crowd + market mood</strong></p>
          <p>${result.crowdMood}</p>
          <p>Price compression vs opener: ~${result.compression}%</p>
        </div>
        <div class="emotion-v2-metric">
          <p><strong>Trade window</strong></p>
          <p>${result.tradeWindow}</p>
          <p>${result.tradeRationale}</p>
        </div>
      </div>

      <p style="margin-top: 0.75rem;">
        <strong>Tags:</strong> ${result.tags.join(" · ")}
      </p>
    </div>
  `;
}

// رندر نسخهٔ دیپ
function renderEmotionDeep() {
  const result = runEmotionEngine("deep");
  const box = document.getElementById("emotion-output");
  if (!box) return;

  const phasesHtml = result.phases
    .map(
      (p) => `
        <li>
          <strong>${p.label}</strong> (${p.minute}) — ${p.description}
        </li>
      `
    )
    .join("");

  box.innerHTML = `
    <div class="emotion-v2">
      <p class="eyebrow">Deep read — Emotion Engine 2.0</p>
      <h4>${result.headline}</h4>
      <p>${result.deepStory}</p>

      <div style="margin: 1.25rem 0;">
        <h5>Regime &amp; momentum map</h5>
        <ol class="emotion-phases">
          ${phasesHtml}
        </ol>
      </div>

      <div class="emotion-v2-grid">
        <div class="emotion-v2-metric">
          <p><strong>Pressure engine</strong></p>
          <p>${result.pressureLabel}</p>
          <p>Composite pressure: ${result.pressureScore} / 100</p>
        </div>
        <div class="emotion-v2-metric">
          <p><strong>Sentiment engine</strong></p>
          <p>${result.crowdMood}</p>
          <p>${result.marketMood}</p>
        </div>
        <div class="emotion-v2-metric">
          <p><strong>Execution engine</strong></p>
          <p>${result.tradeWindow}</p>
          <p>${result.tradeRationale}</p>
        </div>
      </div>

      <p style="margin-top: 0.75rem;">
        <strong>Tags:</strong> ${result.tags.join(" · ")}
      </p>
    </div>
  `;
}

// روی لود صفحه، اگر emotion-output هست، نسخهٔ کوئیک رو نشون بده
document.addEventListener("DOMContentLoaded", () => {
  const box = document.getElementById("emotion-output");
  if (box) {
    renderEmotionQuick();
  }
});
</script>
  </body>
</html>
