// server.js
// BetSense AI - Emotion Probability Engine + Static UI

const express = require('express');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// ----- Middlewares -----
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// (Optional) Allow basic CORS for testing / external tools
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header(
    'Access-Control-Allow-Headers',
    'Origin, X-Requested-With, Content-Type, Accept'
  );
  res.header(
    'Access-Control-Allow-Methods',
    'GET, POST, PUT, PATCH, DELETE, OPTIONS'
  );
  if (req.method === 'OPTIONS') {
    return res.sendStatus(200);
  }
  next();
});

// ----- Static Frontend Serving -----
// اگر فایل‌های front توی پوشه‌ی public هستن:
const publicDir = path.join(__dirname, 'public');
app.use(express.static(publicDir));

// اگر index.html توی ریشه‌ی پروژه است، این fallback کمک می‌کند:
app.get('/', (req, res) => {
  const indexInPublic = path.join(publicDir, 'index.html');
  const indexInRoot = path.join(__dirname, 'index.html');
  res.sendFile(indexInPublic, (err) => {
    if (err) {
      res.sendFile(indexInRoot, (err2) => {
        if (err2) {
          res.status(500).send('index.html not found');
        }
      });
    }
  });
});

// ----- Health check -----
app.get('/health', (req, res) => {
  res.json({ status: 'ok', time: new Date().toISOString() });
});

// ----- Emotion Probability Engine API -----
// POST /api/emotion-probability
// توقع داریم body شامل match_state, market_state, sentiment_state باشد.
app.post('/api/emotion-probability', (req, res) => {
  try {
    const { match_state = {}, market_state = {}, sentiment_state = {} } = req.body || {};

    // --- 1) Odds → Base Probabilities ---
    const homeOdds = Number(market_state.home_odds) || 2.0;
    const drawOdds = Number(market_state.draw_odds) || 3.5;
    const awayOdds = Number(market_state.away_odds) || 4.0;

    const homeBase = 1 / homeOdds;
    const drawBase = 1 / drawOdds;
    const awayBase = 1 / awayOdds;

    const baseSum = homeBase + drawBase + awayBase || 1;

    let pHomeBase = homeBase / baseSum;
    let pDrawBase = drawBase / baseSum;
    let pAwayBase = awayBase / baseSum;

    // --- 2) Emotion Factors ---
    const s = {
      global_sentiment: clamp01(sentiment_state.global_sentiment),
      home_fans_sentiment: clamp01(sentiment_state.home_fans_sentiment),
      away_fans_sentiment: clamp01(sentiment_state.away_fans_sentiment),
      social_volume: clamp01(sentiment_state.social_volume),
      panic_index: clamp01(sentiment_state.panic_index),
      confidence_index: clamp01(sentiment_state.confidence_index)
    };

    const pressureIndex = clamp01(match_state.pressure_index);

    const alpha = 0.3; // شدت اثر احساسات

    const efHome =
      0.4 * s.home_fans_sentiment +
      0.2 * s.global_sentiment +
      0.2 * s.confidence_index -
      0.2 * s.panic_index;

    const efAway =
      0.4 * s.away_fans_sentiment +
      0.2 * s.global_sentiment +
      0.2 * (1 - s.confidence_index) +
      0.2 * s.panic_index;

    const efDraw =
      0.3 * (1 - Math.abs(s.home_fans_sentiment - s.away_fans_sentiment)) +
      0.2 * s.global_sentiment +
      0.2 * (1 - s.panic_index) +
      0.3 * (1 - pressureIndex);

    const emMulHome = 1 + alpha * (efHome - 0.5);
    const emMulAway = 1 + alpha * (efAway - 0.5);
    const emMulDraw = 1 + alpha * (efDraw - 0.5);

    // --- 3) Apply emotion multipliers & renormalize ---
    let pHomeEm = pHomeBase * emMulHome;
    let pDrawEm = pDrawBase * emMulDraw;
    let pAwayEm = pAwayBase * emMulAway;

    const emSum = pHomeEm + pDrawEm + pAwayEm || 1;

    pHomeEm /= emSum;
    pDrawEm /= emSum;
    pAwayEm /= emSum;

    // --- 4) Shifts & volatility ---
    const homeShift = pHomeEm - pHomeBase;
    const drawShift = pDrawEm - pDrawBase;
    const awayShift = pAwayEm - pAwayBase;

    const volatility =
      Math.abs(homeShift) + Math.abs(drawShift) + Math.abs(awayShift);

    const confidence = clamp01(1 - volatility); // هر چه نوسان بیشتر، confidence کمتر

    // --- 5) Signals (علامت‌های مهم برای UI / خریدار) ---
    const signals = [];

    if (homeShift > 0.05) {
      signals.push('HOME_SENTIMENT_BOOST');
    }
    if (awayShift < -0.05) {
      signals.push('AWAY_SENTIMENT_COLLAPSING');
    }
    if (volatility > 0.2) {
      signals.push('HIGH_EMOTIONAL_VOLATILITY');
    }
    if (s.social_volume > 0.8) {
      signals.push('SOCIAL_ACTIVITY_SPIKE');
    }

    return res.json({
      base_probabilities: {
        home: round4(pHomeBase),
        draw: round4(pDrawBase),
        away: round4(pAwayBase)
      },
      emotion_adjusted_probabilities: {
        home: round4(pHomeEm),
        draw: round4(pDrawEm),
        away: round4(pAwayEm)
      },
      emotion_impact: {
        home_shift: round4(homeShift),
        draw_shift: round4(drawShift),
        away_shift: round4(awayShift),
        confidence: round4(confidence),
        volatility: round4(volatility)
      },
      signals
    });
  } catch (err) {
    console.error('Emotion Probability Engine error:', err);
    return res.status(500).json({
      error: 'Emotion Probability Engine failed',
      details: err.message
    });
  }
});

// ----- Helper functions -----
function clamp01(value) {
  const n = Number(value);
  if (isNaN(n)) return 0.5; // اگر داده نداشتیم، حالت خنثی
  return Math.max(0, Math.min(1, n));
}

function round4(value) {
  return Math.round((value + Number.EPSILON) * 10000) / 10000;
}

// ----- Start server -----
app.listen(PORT, () => {
  console.log(`BetSense AI server running on port ${PORT}`);
});
