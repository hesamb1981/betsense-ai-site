<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NSI Engine – BetSense</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050712;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 4px;
    }

    h2 {
      font-size: 1.2rem;
      margin-top: 24px;
      margin-bottom: 8px;
    }

    .tagline {
      opacity: 0.75;
      font-size: 0.95rem;
      margin-bottom: 24px;
    }

    .card {
      background: #0b0f20;
      border-radius: 12px;
      padding: 16px 14px;
      margin-bottom: 16px;
      border: 1px solid #202744;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #3f82ff;
      color: #c2d4ff;
    }

    button {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
      background: #3f82ff;
      color: #fff;
      font-weight: 500;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .btn-secondary {
      background: #1f273b;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .status {
      font-size: 0.85rem;
      opacity: 0.8;
      margin-top: 4px;
    }

    .status-ok {
      color: #4ade80;
    }

    .status-error {
      color: #f97373;
    }

    .api-base {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-top: 6px;
      word-break: break-all;
    }

    pre {
      background: #020414;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.8rem;
      overflow-x: auto;
      border: 1px solid #1c2140;
      white-space: pre-wrap;
      word-break: break-word;
    }

    a {
      color: #7fb0ff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>

  <!-- API base URL (defined in api-config.js) -->
  <script src="api-config.js"></script>
</head>
<body>
  <div class="page">
    <h1>NSI Engine Console</h1>
    <div class="tagline">
      Neuro-Stress Index engine demo – این صفحه مستقیماً به بک‌اند BetSense روی Render وصل است.
    </div>

    <!-- CARD: Connection info -->
    <div class="card">
      <div class="card-header">
        <strong>Backend connection</strong>
        <span class="badge">NSI API</span>
      </div>
      <div id="conn-status" class="status">Preparing base URL…</div>
      <div id="conn-base" class="api-base"></div>
    </div>

    <!-- CARD: Health check -->
    <div class="card">
      <div class="card-header">
        <strong>1) NSI health check</strong>
      </div>
      <p style="font-size:0.9rem; opacity:0.85; margin:0 0 8px;">
        این درخواست فقط برای تست اتصال است و وضعیت کلی NSI را برمی‌گرداند.
      </p>
      <div class="buttons">
        <button id="btn-health">Run health test</button>
        <a id="link-health" href="#" target="_blank" class="status">Open raw JSON ↗</a>
      </div>
      <div id="health-status" class="status"></div>
      <pre id="health-output">{ }</pre>
    </div>

    <!-- CARD: Demo analysis -->
    <div class="card">
      <div class="card-header">
        <strong>2) NSI demo analysis</strong>
      </div>
      <p style="font-size:0.9rem; opacity:0.85; margin:0 0 8px;">
        این درخواست دمو، یک سناریوی کامل NSI (مثل Arsenal – Spurs) را از سرور می‌گیرد.
      </p>
      <div class="buttons">
        <button id="btn-demo">Run demo analysis</button>
        <a id="link-demo" href="#" target="_blank" class="status">Open raw JSON ↗</a>
      </div>
      <div id="demo-status" class="status"></div>
      <pre id="demo-output">{ }</pre>
    </div>
  </div>

  <script>
    // --- Base URL ---
    const DEFAULT_BASE = "https://betsense-backend.onrender.com";
    const API_BASE_URL = (window.API_BASE_URL || DEFAULT_BASE).replace(/\/+$/, "");

    const connStatus = document.getElementById("conn-status");
    const connBase = document.getElementById("conn-base");

    connStatus.textContent = "Using backend:";
    connStatus.classList.add("status-ok");
    connBase.textContent = API_BASE_URL;

    // Build endpoint URLs
    const HEALTH_URL = API_BASE_URL + "/api/nsi/health";
    const DEMO_URL   = API_BASE_URL + "/api/nsi/demo";

    document.getElementById("link-health").href = HEALTH_URL;
    document.getElementById("link-demo").href   = DEMO_URL;

    // Helpers
    function setStatus(el, msg, ok) {
      el.textContent = msg;
      el.classList.remove("status-ok", "status-error");
      if (ok === true) el.classList.add("status-ok");
      if (ok === false) el.classList.add("status-error");
    }

    async function runRequest({ url, button, statusEl, outputEl }) {
      try {
        button.disabled = true;
        setStatus(statusEl, "Requesting…", null);
        outputEl.textContent = "";

        const res = await fetch(url);
        const text = await res.text();

        if (!res.ok) {
          setStatus(statusEl, "Error " + res.status + " – " + res.statusText, false);
          outputEl.textContent = text || "{ }";
          return;
        }

        let parsed;
        try {
          parsed = JSON.parse(text);
          outputEl.textContent = JSON.stringify(parsed, null, 2);
        } catch (e) {
          // اگر JSON نبود، همان متن خام نمایش داده شود
          outputEl.textContent = text;
        }

        setStatus(statusEl, "OK", true);
      } catch (err) {
        console.error(err);
        setStatus(statusEl, "Network error", false);
        outputEl.textContent = String(err);
      } finally {
        button.disabled = false;
      }
    }

    // Wire buttons
    document.getElementById("btn-health").addEventListener("click", () => {
      runRequest({
        url: HEALTH_URL,
        button: document.getElementById("btn-health"),
        statusEl: document.getElementById("health-status"),
        outputEl: document.getElementById("health-output"),
      });
    });

    document.getElementById("btn-demo").addEventListener("click", () => {
      runRequest({
        url: DEMO_URL,
        button: document.getElementById("btn-demo"),
        statusEl: document.getElementById("demo-status"),
        outputEl: document.getElementById("demo-output"),
      });
    });
  </script>
</body>
</html>
